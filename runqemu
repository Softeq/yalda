#!/usr/bin/env bash
mkdir -p home

arch=x86_64

ENABLE_KVM=
if [ -c /dev/kvm ]; then
    ENABLE_KVM=-enable-kvm
fi

while getopts a: flag
do
    case "${flag}" in
        a) arch=${OPTARG};;
    esac
done

#TODO unhardcode
if [[ "$arch" == "arm" ]]; then
    qemu-system-arm \
            -M raspi2 \
            -append " rdinit=/sbin/init rw earlyprintk loglevel=8 console=ttyAMA0" \
            -cpu arm1176 \
            -initrd initrd.cpio.gz \
            -kernel linux/arch/arm/boot/zImage \
            -dtb linux/arch/arm/boot/dts/bcm2836-rpi-2-b.dtb \
            -m 1G \
            -smp 4 \
            -nographic  \
            -usb \
            -gdb tcp::1234
elif [[ "$arch" == "x86_64" ]]; then
    qemu-system-x86_64 \
            -initrd initrd.cpio.gz \
            -kernel linux/arch/x86_64/boot/bzImage \
            -append "nokaslr, console=ttyS0" \
            -gdb tcp::1234 \
            -nographic \
            $ENABLE_KVM \
            -fsdev local,id=home_dev,path=home,security_model=none -device virtio-9p-pci,fsdev=home_dev,mount_tag=host_home \
            -fsdev local,id=share_dev,path=./,security_model=none -device virtio-9p-pci,fsdev=share_dev,mount_tag=host_share \
            -m 2g \
            -usb \
            -device usb-host,vendorid=0x1a86,productid=0x5512 \
            -device usb-host,vendorid=0x04b4,productid=0x0005 \
            -device usb-host,vendorid=0x04b4,productid=0x0007 \
            -device usb-host,vendorid=0x04b4,productid=0x0009 \
            -device usb-host,vendorid=0x04b4,productid=0x000a \
            -device usb-host,vendorid=0x04b4,productid=0x00ff \

#            -usb -device usb-host,hostbus=1,hostaddr=16 \
#            -S
else
    echo "Unsupported architecture "$arch""
    exit
fi
